<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>mems-创建项目</title>
    <link href="../css/creat-pro.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<!--header-->
<header id="header" class="header" v-html="datas">
    <div>{{datas}}</div>
</header>

<!--menu-->
<aside id="aside" class="aside" v-html="datas">
    <div>{{datas}}</div>
</aside>


<!--content-->
<div class="content"  style="height: 100%;">
    <div class="page-header">
        <div class="header-info"><i></i><a href="mems-pro-creat.html">创建项目</a></div>
    </div>
    <div class="creat-pro" style="height: 80%;">
        <div class="pro-head"><i></i>创建项目</div>
        <div class="steps">
            <div class="line">
                <i></i>
                <i></i>
            </div>
            <div class="circle">
                <p class="done">1</p><p>2</p><p>3</p>
            </div>
            <div class="s-d">
                <p class="done">选择医院</p><p>完善信息</p><p>完成</p>
            </div>
        </div>

        <div class="search-box">
            <h3>选择医院</h3>
            <div class="search-input">
                <input type="text" name="" id="serchkeywords">
                <div style="display: none;">
                    <input type="hidden" id="area-v"/>
                    <input type="hidden" id="provice-v">
                    <input type="hidden" id="city-v">
                    <input type="hidden" id="hospital-v">
                </div>
            </div>

            <div class="show-box"  style="display: none;overflow-y:scroll;" id="showkeylist">
                <ul class="key-list" id="keyul">
                没有匹配到！
                </ul>
            </div>

            <div class="show-box" style="display: none;" id="showselect">
                <div class="select-area clear">
                    <div class="wap" style="width: 15%;">
                        <ul id="district" >
                        </ul>
                    </div>

                    <div class="wap" style="width: 20%;">
                        <ul id="provice">
                        </ul>
                    </div>
                    <div class="wap" style="width: 25%;">
                        <ul id="city">
                           
                        </ul>
                    </div>
                    <div class="wap" style="width: 40%;">
                        <ul id="hospital" style="width: 250px;">
                        </ul>
                    </div>
                </div>
            </div>

            <div class="btns">
                <a class="pro-btn pro-sure" onclick="nextStep()" >下一步</a>
            </div>
            <div>医院未找到？&emsp;<a class="pro-btn" href="mems-pro-creat-2.html">直接创建</a></div>
        </div>
    </div>
</div>
<script src="../js/vue.js" type="text/javascript"></script>
<script src="../js/jquery.min.js"></script>
<script src="../js/jquery.cookie.js"></script>
<script src="../js/common.js"></script>
<script type="text/javascript">


function getDistrictdom(id){
    var _id = $('#'+id);
    $.ajax({
        url:_ip+'/common/getDistrict',
        type: 'GET',
        dataType: 'jsonp',
        contentType:'application/json',
        jsonpCallback: 'getDistrict',
        success: function(json) {
            var json = json.data;
            var h = '';
            for(var k = 0 , kk = json.length; k < kk; k++){
                h += '<li>'+json[k]+'<input type="hidden" value="'+json[k]+'"/><i>></i></li>'
            }            
            _id.html(h);

        }
    })
}
function getProvicedom(id,area){  //获取省份列表
    $.ajax({
        url:_ip+'/common/getPrivence?area='+area,
        type: 'GET',
        dataType: 'jsonp',
        contentType:'application/json',
        jsonpCallback: 'getprovice',
        success: function(json) {
            var json = json.data;
            var h = '';
            for(var k = 0 , kk = json.length; k < kk; k++){
                h += '<li>'+json[k]+'<input type="hidden" value="'+json[k]+'"/><i>></i></li>'
            }            
            $('#'+id).html(h);
        }
    })
}
function getCity(id,provice,area){ //获取城市列表
    $.ajax({
        url:_ip+'/common/getCity?area='+area+'&privence='+provice,
        type: 'GET',
        dataType: 'jsonp',
        contentType:'application/json',
        jsonpCallback: 'getcity',
        success: function(json) {
            var json = json.data;
            var h = '';
            for(var k = 0 , kk = json.length; k < kk; k++){
                h += '<li>'+json[k]+'<input type="hidden" value="'+json[k]+'"/><i>></i></li>'
            }           
            $('#'+id).html(h);
        }
    })
}

function getHospital(id,city){ //获取医院列表
    var data= {};
    data['city'] = city;
    $.ajax({
        url:_ip+'/hospital/getHospitalList',
        type: 'post',
        xhrFields: {
           withCredentials: true
        },
        crossDomain: true,
        dataType: 'json',
        contentType:'application/json',
        data:JSON.stringify(data),
        success: function(json) {

            if(json.message === 'LOGIN') {
                window.location.href = 'user-login.html';
                return false;
            }

            var json = json.data;
            var h = '';
            console.log(json.length);
            for(var k = 0 , kk = json.length; k < kk; k++){
                h += '<li>'+json[k].chineseName+'<input type="hidden" value="'+json[k].chineseName+'"/></li>'
            }
            $('#hospital').html(h);
        }
    })
}

function getinputVal(id1,id2,id3,id4) {
    var v1 = $('#'+id1).val();
    var v2 = $('#'+id2).val();
    var v3 = $('#'+id3).val();
    var v4 = $('#'+id4).val();
    var t = '';
    if(v1){
        t = v1;
    }
    if (v2){
        t = v1 +'／' + v2
    }
    if(v3){
        t = v1 +'／' + v2+'／' + v3;
    }
    if(v4){
        t = v1 +'／' + v2+'／' + v3+'／' + v4;

    }
    $('#serchkeywords').val(t);
}
getDistrictdom('district');


$('#district').on('click','li',function(){

    $('#city').html('');
    $('#hospital').html('');

    var d = $(this).find('input').val();
    $(this).addClass('current');
    $(this).siblings().removeClass('current');
    getProvicedom('provice',d);
    $('#serchkeywords').val(d);
    $('#area-v').val(d);

    getinputVal('area-v','provice-v','city-v','hospital-v');

})
$('#provice').on('click','li',function(){
    $('#hospital').html('');
    $(this).addClass('current');
    $(this).siblings().removeClass('current');
    var a,p;
    $('#district').find('li').each(function(){
        if($(this).hasClass('current')){
            a = $(this).find('input').val();
        }
    })
    p = $(this).find('input').val();
    $('#provice-v').val(p);
    getinputVal('area-v','provice-v','city-v','hospital-v')

    getCity('city',p,a);
})
$('#city').on('click','li',function(){
    $(this).addClass('current');
    $(this).siblings().removeClass('current');

    var c = $(this).find('input').val();
    $('#city-v').val(c);
    getinputVal('area-v','provice-v','city-v','hospital-v')
    getHospital('hospital',c);
})
$('#hospital').on('click','li',function () {
    $(this).addClass('current');
    $(this).siblings().removeClass('current');
    var h = $(this).find('input').val();
    $('#hospital-v').val(h);
    getinputVal('area-v','provice-v','city-v','hospital-v')
})
    var showkeylist = $('#showkeylist');
    var showselect  = $('#showselect');
    $('#serchkeywords').on('focus',function(){
        var s = showkeylist.css('display');
        if(s == 'block'){
            showkeylistdo()
        }else{
            showselectarea()
        }
    })
    .on('keyup',function(){
        var v = $(this).val();
        if(v.length >= 1){
            showkeylistdo()
            // keysearch(v);
            if(v.length >= 8){
                keysearch(v);
            }
            
        }else{
            showselectarea()
        }
    })

    function showkeylistdo(){
        showselect.css({'display':'none'});
        showkeylist.css({'display':'block'});
    }
    function showselectarea(){
        showselect.css({'display':'block'});
        showkeylist.css({'display':'none'});
    }
    function nextStep() {
        var s = $('#serchkeywords').val();
        if(s != ''){
            location.href = 'mems-pro-creat-2.html?position='+encodeURI($('#serchkeywords').val());
        }
    }
    function keysearch(key){
        var url  = _ip+'/hospital/getHospitalList';
        var data = {
            "chineseName": key
        }
        $.ajax({
            url:url,
            type : "POST",
            xhrFields: {
                withCredentials: true
            },
            crossDomain: true,
            dataType: 'json',
            contentType:'application/json',
            data:JSON.stringify(data),
            success:function(data){
                if(data.success){
                    var h = '';
                    var data = data.data;
                    if(data && data.length){
                        for(var k = 0, kk = data.length; k < kk ;k ++){
                            h += '<li>西南区／'+data[k].province+'／'+data[k].city+'／'+data[k].chineseName+'</li>';
                        }
                        $('#keyul').html(h);
                    }else{
                        $('#keyul').html('没有匹配到！');
                    }
                    
                }else{
//                    alert('搜索失败, 请稍后重试！');
                }
            }
        })
   }
   $('#keyul').on('click','li',function(){
        $('#serchkeywords').val($(this).text() );
   })
</script>
</body>
</html>