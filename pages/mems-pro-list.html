<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>mems-项目-列表</title>
        <link href="../css/mems-index.css" type="text/css" rel="stylesheet"/>
        <link rel="stylesheet" href="http://www.jq22.com/jquery/font-awesome.4.6.0.css">
        <link href="../css/foundation-datepicker.css" rel="stylesheet"/>
    </head>
<body>
<!--header-->
<header id="header" class="header" v-html="datas">
    <div>{{datas}}</div>
</header>

<!--menu-->
<aside id="aside" class="aside" v-html="datas">
    <div>{{datas}}</div>
</aside>
<!-- <aside class="aside">
    <div class="logo">
        运营平台
    </div>
    <ul class="menu">
        <li>
            <div class="menu-first"><i class="dash"></i>Dashboard<l></l></div>
        </li>
        <li>
            <div class="menu-first current" ><i class="project"></i>项目管理<l></l></div>
            <dl class="menu-second">
                <dd><a href="#">待办事项</a></dd>
                <dd><a href="mems-pro-list.html">项目列表</a></dd>
            </dl>
        </li>
        <li>
            <div class="menu-first"><i class="need"></i>需求管理<l></l></div>
            <dl class="menu-second">
                <dd><a href="pm-need-list.html" >需求池</a></dd>
                <dd><a href="pm-bug-list.html">缺陷池</a></dd>
            </dl>
        </li>
        <li>
            <div class="menu-first current"><i class="system"></i>系统配置<l></l></div>
            <dl class="menu-second">
                <dd><a href="user-manage.html" >用户管理</a></dd>
                <dd><a href="organize-architecture.html" >组织架构</a></dd>
                <dd><a href="tag-manage.html" class="current">标签管理</a></dd>
            </dl>
        </li>
        <li>
            <div class="menu-first"><i class="project"></i>文档管理<l></l></div>
            <dl class="menu-second">
                <dd><a href="doc-manage.html">文档管理</a></dd>
            </dl>
        </li>
    </ul>
</aside> -->

<!--content-->
<div class="content">
    <div class="page-header">
        <div class="header-info"><i></i><a href="/innerOpera/pages/mems-need-list.html">项目列表</a></div>
    </div>
    <div class="page-inner" style="padding-top: 13px">
    <ul class="item-tab clear">
            <li><div class="current">我的项目</div></li>
            <li><div>区域项目</div></li>
            <li><div>全部项目</div></li>
        </ul>
        <table class="mems-search">
            <tbody>
                <tr>
                    <td>&emsp;&emsp;项目名称：<select id="needSource"></select></td>
                    <td>&emsp;&emsp;&emsp;&emsp;segmentation：<select id="Segmentation"></select></td>
                    <td>&emsp;&emsp;级别：<select id="level"></select></td>
                    <td>商务阶段：<select id="bussType"></select></td>
                    <td align="right"><button class="btn" id="checkout">查询</button></td>
                </tr>
            </tbody>

            <tbody id="more-search" >
                <tr>
                    <td colspan="5">&emsp;&emsp;&emsp;&emsp;区域：<select id="district"><option>请选择</option></select>&emsp;<select style="width: 200px" id="privence"><option>请选择</option></select>&emsp;<select id="city"><option>请选择</option></select></td>
                </tr>
            </tbody>
        </table>
        <div class="commit-new-item"><a class="btn" href="mems-pro-creat-1.html">创建项目&nbsp;<b>+</b></a>&emsp;<a class="btn" onclick="exportExcel();">导出&nbsp;</a></div>
        
        <div class="item-content">
            <div class="table-box">
                <table>
                    <thead>
                        <tr class="odd">
                            <th><input type="checkbox" name="">全选</th>
                            <th>区域</th>
                            <th>项目</th>
                            <th>segmentation</th>
                            <th>级别</th>
                            <th>商务阶段</th>     
                        </tr>
                    </thead>
                    <tbody id="bodyList">
                        <!-- <tr>
                            <td><input type="checkbox" name=""></td>
                            <td><a href="mems-pro-detail-baseinfo.html" class="link">安徽省第一人民医院</a></td>
                            <td>省级综合领先医院</td>
                            <td>三级甲等</td>
                            <td>见面</td>
                            <td>签约实施</td>
                        </tr> -->
                    </tbody>
                </table>
            </div>
            <div class="pages clear">
                <div class="page-list clear" id="pageList">
                </div>
            </div>
        </div>
    </div>

</div>


<script src="../js/vue.js"></script>
<script src="../js/jquery.min.js"></script>
<script src="../js/common.js"></script>
<script src="../js/foundation-datepicker.min.js"></script>
<script src="../js/common.js"></script>
<script>
    _API.getNeedSource('needSource',0,true)
        .getPSegmentationList('Segmentation',0,true)
        .getPLevelList('level',0,true)
        .dynamicDistrick('district','privence','city');


    function getData(p,checPara){
        var PerPage = 20;
        var url  = _ip+'/project/getProjectList?page='+p+'&size='+PerPage;
        var data = checPara || {};
        $.ajax({
            url:url,
            type : "POST",
            dataType: 'json',

            xhrFields: {
               withCredentials: true
            },
            crossDomain: true,

            contentType:'application/json',
            data:JSON.stringify(data),
            success:function(json){

                if(json.message === 'LOGIN') {
                    window.location.href = 'user-login.html';
                    return false;
                }

                if(!json.data || json.data.length <= 0){
                    $('#bodyList').html('<tr><td colspan="7">暂无数据！</td></tr>');
                    $('#pageList').html('');
                    return false;
                }
                var _data     = [];
                var _pager    = [];
                var totalPage = json.totlePage;
                var prev      = p-1;
                if(prev < 1)prev = 1;
                var next = p + 1;
                if(next > totalPage)next = totalPage;
                for(var k = 0, kk = json.data.length; k < kk; k++){
                    var msg = json.data[k];

                    _data.push('<tr>');
                    _data.push('<td><input type="checkbox" name=""></td>');
                    _data.push('<td>'+msg.area+'</td>');
                    _data.push('<td><a href="mems-pro-detail-baseinfo.html?id='+msg.id+'" class="link" title="'+msg.name+'">'+(msg.name.length<12?msg.name:msg.name.substring(0,12)+'...' )+'</a></td>');
                    _data.push('<td>'+msg.segmentation+'</td>');
                    _data.push('<td>'+msg.level+'</td>');
                    _data.push('<td>'+msg.businessType+'</td>');
                
                }
                _pager.push('<span>共：'+ totalPage +'页</span>');
                _pager.push('<span>您正在第：'+p+'页</span>')
                _pager.push('<a href="javascript:;" class="page-pre" onclick="getData('+prev+');return !1;">上一页</a>');
                _pager.push('<a href="javascript:;" class="page-next" onclick="getData('+next+');return !1;">下一页</a>');
                _pager.push('<span>前往第</span>');
                _pager.push('<input type="text" id="goToPage"/>');
                _pager.push('<span>页</span>');

                $('#bodyList').html(_data.join(""));
                $('#pageList').html(_pager.join(""));
                $('#goToPage').blur(function () {
                    var v = $(this).val();
                    if(!/^[1-9]\d*$/.test(v)){
                        return false;
                    }
                    if(v <= 1){
                        getData(1);
                        return false;
                    }
                    if(v >= totalPage){
                        getData(totalPage);
                        return false;
                    }
                })
            }
        })
    }
    getData(1);
    $('#checkout').on('click',function(){
        var para = {
            "name": $('#needSource').val(), 
            "segmentation": $('#Segmentation').val(), 
            "level": $('#level').val(), 
            "businessType": $('#bussType').val(),
            "area": $('#district').val(), 
            "province": $('#privence').val(), 
            "city": $('#city').val()
        }
        getData(1,para);
    })



    var nowTemp = new Date();
    var now = new Date(nowTemp.getFullYear(), nowTemp.getMonth(), nowTemp.getDate(), 0, 0, 0, 0);
    var checkin = $('#dpd1').fdatepicker({
        onRender: function (date) {
            return date.valueOf() < now.valueOf() ? '' : '';
        },
        // pickTime: true,
        format: 'yyyy-mm-dd'
    }).on('changeDate', function (ev) {
        if (ev.date.valueOf() > checkout.date.valueOf()) {
            var newDate = new Date(ev.date)
            newDate.setDate(newDate.getDate() + 1);
            checkout.update(newDate);
        }
        checkin.hide();
        $('#dpd2')[0].focus();
    }).data('datepicker');
    var checkout = $('#dpd2').fdatepicker({
        onRender: function (date) {
            return date.valueOf() <= checkin.date.valueOf() ? 'disabled' : '';
        },
        // pickTime: true,
        format: 'yyyy-mm-dd'
    }).on('changeDate', function (ev) {
        checkout.hide();
    }).data('datepicker');





    // exportExcel()
    function exportExcel(){
        var html = '';
        html += '<div class="share-box">';
            html += '<p class="relative-title">导出列表</p>';
            html += '<div class="con-box">';
               
                html += '<table class="exportItem" style="width:92%;height:50px;margin:0 auto"><tr height="50">';
                    html += '<td>项目名称：<input id="exname"/></td>';
                    html += '<td>segmentation：<select id="exsegmentation"></select></td>';
                    html += '<td>级别：<select id="exlevel"></select></td>';
                    html += '<td>商务阶段：<select id="exbussType"><option>见面</option><option>电话</option></select></td>';
                    html += '<td>紧急程度：<select id="exemergency"><option>继续跟进</option></select></td></tr>';
                    
                    html += '<tr>';
                    html += '<td>拜访阶段：<select id="exvisitResult"><option>继续跟进</option></select></td>';

                    html += '<td colspan="3">区域：区域：<select id="exdistrict"><option>请选择</option></select>&emsp;<select id="exprivence"><option>请选择</option></select>&emsp;<select id="excity"><option>请选择</option></select></td>';
                    html += '<td>预计采购时间：<input id="procurementTime"/></td>';
                html += '</tr></table>';
            html += '</div>';
            html += '<div class="buttons"><a class="cancel" href="javascript:$$.closeLayer()">取消</a><a id="confirmRelative" class="confirm">确认</a></div>'
        html += '</div>';


        $$.layer(html, {
            isShowMask: true,
            fixedBoxTop:'100px',
            zIndex:99,
            contentBoxWidth: "55%"
        });

        _API.getPSegmentationList('exsegmentation',0,true)
        .getPLevelList('exlevel',0,true)
        .getPBussTypeList('exbussType')
        .getEmergencyList('exemergency',0,true)
        .getVisitStatusList('exvisitResult')
        .dynamicDistrick('exdistrict','exprivence','excity');

        $('#confirmRelative').on('click',function(){
            var url = _ip + '/customer/exportReport';
            var data = {
                "name":$('#exname').val(),
                "segmentation":$('#exsegmentation').val(),
                "level":$("#exlevel").val(),
                "businessType":$("#exbussType").val(),
                "emergency":$('#exemergency').val(),
                "visitResult":$('#exvisitResult').val(),
                "district":$('#exdistrict').val(),
                "province":$("#exprivence").val(),
                "city":$('#excity').val(),
                "date":$('#procurementTime').val()
            }
            $.ajax({
                url:url,
                type: 'POST',
                dataType: 'json',
                contentType:'application/json',
                data:JSON.stringify(data),
                success: function(json) {
                    $$.closeLayer()
                    // if(json.success){
                    //     clientDataCard.getAllCard();
                    //     $$.closeLayer()
                    // }else{
                    //     alert('添加失败，稍后重试！')
                    // }
                }
            })
        })



        var nowTemp = new Date();
        var now = new Date(nowTemp.getFullYear(), nowTemp.getMonth(), nowTemp.getDate(), 0, 0, 0, 0);
        $('#procurementTime').fdatepicker({
            format: 'yyyy-mm-dd',
            onRender: function (date) {
                return date.valueOf() < now.valueOf() ? 'disabled' : '';
            }
        });
    }

</script>
</body>
</html>