<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>pm-bug详情-修改</title>
    <link href="../css/list-detial.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<!--header-->
<header id="header" class="header" v-html="datas">
    <div>{{datas}}</div>
</header>

<!--menu-->
<aside id="aside" class="aside" v-html="datas">
    <div>{{datas}}</div>
</aside>
<!-- <aside class="aside">
    <div class="logo">
        运营平台
    </div>
    <ul class="menu">
        <li>
            <div class="menu-first"><i class="dash"></i>Dashboard<l></l></div>
        </li>
        <li>
            <div class="menu-first" ><i class="project"></i>项目管理<l></l></div>
            <dl class="menu-second">
                <dd><a href="#">待办事项</a></dd>
                <dd><a href="mems-pro-list.html">项目列表</a></dd>
            </dl>
        </li>
        <li>
            <div class="menu-first"><i class="need"></i>需求管理<l></l></div>
            <dl class="menu-second">
                <dd><a href="pm-need-list.html" >需求池</a></dd>
                <dd><a href="pm-bug-list.html">缺陷池</a></dd>
            </dl>
        </li>
        <li>
            <div class="menu-first"><i class="system"></i>系统配置<l></l></div>
            <dl class="menu-second">
                <dd><a href="user-manage.html" >用户管理</a></dd>
                <dd><a href="organize-architecture.html" >组织架构</a></dd>
                <dd><a href="tag-manage.html" class="current">标签管理</a></dd>
            </dl>
        </li>
        <li>
            <div class="menu-first"><i class="project"></i>文档管理<l></l></div>
            <dl class="menu-second">
                <dd><a href="doc-manage.html">文档管理</a></dd>
            </dl>
        </li>
    </ul>
</aside> -->

<!--content-->
<div class="content">
    <div class="page-header">
        <div class="header-info"><i></i><a href="#">缺陷列表</a>&nbsp;>&nbsp;缺陷详情</div>
    </div>
    <div class="page-inner">
        <div class="page-content">
            <div class="table-head clear"><div class="left document-name"><i class="bug-i"></i>No.01234</div><div class="right edit"><a onclick="returnList()" class="sure">取消</a><a onclick="commitEdit()" class="sure">保存</a></div></div>
            <div class="table-cont">
                <table class="content-table">
                    <tr>
                        <td>缺陷主题：</td>
                        <td colspan="2"><input id="name" /></td>

                    </tr>
                    <tr>
                        <td>来源：</td>
                        <td><select id="source"></select></td>
                        <td>紧急程度：</td>
                        <td><select id="level"></select></td>
                    </tr>
                    <tr>
                        <td>产品：</td>
                        <td><select id="product"></select></td>
                        <td>功能模块:</td>
                        <td><select id="functionList"></select></td>
                    </tr>
                    <tr>
                        <td>使用平台：</td>
                        <td><select id="plat"></select></td>
                        <td>缺陷类型：</td>
                        <td><select id="issueType"></select></td>
                    </tr>

                    <tr>
                        <td>使用网络：</td>
                        <td><select id="networkType"></select></td>
                        <td>浏览器及其版本：</td>
                        <td><input id="browser"></td>
                    </tr>
                    <tr>
                        <td>缺陷状态：</td>
                        <td><select id="status"></select></td>
                        <td>优先级：</td>
                        <td><select id="priority"></select></td>
                    </tr>
                    <tr>
                        <td>手机及型号：</td>
                        <td colspan="3"><input id="mobileType"></td>
                    </tr>

                    <tr class="area">
                        <td>缺陷描述：</td>
                        <td colspan="3">
                            <textarea id="discribe"></textarea>
                        </td>
                    </tr>
                    
                    <tr class="area">
                        <td>反馈信息：</td>
                        <td colspan="3">
                            <textarea id="remark"></textarea>
                        </td>
                    </tr>
                    <tr class="area">
                        <td>附件：</td>
                        <td colspan="3">
                            <a href="javascript:;" class="a-upload" id="fileUpload"><input id="file" value="请选择" type="file"/>点击这里上传</a>
                            <ul class="addAttachmentList" id="addAttachmentList">
                            </ul>
                        </td>
                    </tr>
                </table>

                <!-- <table class="table-log">
                    <thead>
                    <tr>
                        <th><span class="left">操作日志</span><span class="right" id="log">隐藏日志</span></th>
                    </tr>
                    </thead>

                    <tbody id="log-body">
                        <tr>
                            <td>
                                <span class="name">小丽</span><span class="opera">将状态由 <b>新建</b> 变更为 <b>开发中</b></span><span class="time">2016.12.26  13：28</span>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <span class="name">小丽</span><span class="opera">将状态由 <b>新建</b> 变更为 <b>开发中</b></span><span class="time">2016.12.26  13：28</span>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <span class="name">小丽</span><span class="opera">将状态由 <b>新建</b> 变更为 <b>开发中</b></span><span class="time">2016.12.26  13：28</span>
                            </td>
                        </tr>
                    </tbody>

                </table> -->
            </div>

        </div>
    </div>
</div>
<script src="../js/jquery.min.js"></script>
<script src="../js/jquery.cookie.js"></script>
<script src="../js/vue.js" type="text/javascript"></script>
<script src="../js/common.js"></script>

<script type="text/javascript">


    var _id = getUrlId();
    function returnList(){
        location.href = 'pm-bug-detail.html?id='+_id;
    }

    // 上传文件
    attachment.init({
        fileUpload:$('#fileUpload'),
        addAttachmentList:$('#addAttachmentList')
    }).deleteFile();
    
    updata();
    function updata(){
        var url  = _ip+'/issue/getIssueById?callback=update&id='+_id;
        $.ajax({
            url:url,
            type: 'GET',
            dataType: 'jsonp',
            contentType:'application/json',
            jsonpCallback: 'update',
            success:function(data){
                if(data.success){
                    var data = data.data;
                    $('#name').val(data.name);

                    _API.getIssueType('issueType',data.issueType)
                        .getNeedSource('source',data.projectId)
                        .getTypeList('typeList',data.type)
                        .getProductList('product',data.product)
                        .getPlatformList('plat',data.plat)
                        .getFunctionList('functionList',data.feature)
                        .getNetWorkList('networkType',data.networkType)
                        .getLevelList('level',data.level)
                        .getIssueStatusList('status',data.status)
                        .getPriorityList('priority',data.priority);
                    $('#browser').val(data.browser);
                    $('#mobileType').val(data.mobileType);
                    $('#discribe').val(data.discribe);
                    $('#scenario').html(data.scenario);
                    $('#nowSolution').html(data.nowSolution);
                    $('#sugSolution').html(data.sugSolution);
                    $('#remark').html(data.remark);

                    data.attachment && attachment.getAttachmentList(data.attachment.split(','));       

                }else{
                    alert('上传失败, 请稍后重试！');
                }
            }
        })
    }

    


    var needName = $('#needName');
        scenario = $('#scenario');
    needName.focus(function(){
        needName.removeClass('error-i');
    })
    scenario.focus(function(){
        scenario.removeClass('error-i');
    })

    // 提交编辑
    function commitEdit() {
        if(needName.val() == ''){
            needName.addClass('error-i');
            return
        } 
        if( scenario.val() == ''){
            scenario.addClass('error-i');
            return;
        }

        var attachment = [];
        var li = $('#addAttachmentList').find('li');
        if(li.length >= 1){
            li.each(function(){
                attachment.push( $(this).attr('rel') );
            })
        }

        var url  = _ip+'/issue/updateIssue'
        var data = {
            "id":_id,
            "name":$('#name').val(),
            "type":$('#issueType').val(),
            "networkType":$('#networkType').val(),
            "mobileType":$('#mobileType').val(),
            "product":$('#product').val(),
            "plat":$('#plat').val(),
            "feature":$('#functionList').val(),
            "browser":$('#browser').val(),
            "discribe":$('#discribe').val(),
            "remark":$('#remark').val(),
            "creater":"测试账号",
            "attachment":attachment.join(','),
            "status":$('#status').val(),
            "level":$('#level').val(),
            "priority":$('#priority').val(),
            "projectId":$('#source').val()
        }
        $.ajax({
            url:url,
            type : "post",
            dataType: 'json',
            contentType:'application/json',
            data:JSON.stringify(data),
            success:function(data){
                if(data.success){

                    location.href = 'pm-bug-detail.html?id='+_id;
                }else{
                    alert('更新失败, 请稍后重试！');
                }
            }
        })
   }
</script>
</body>
</html>